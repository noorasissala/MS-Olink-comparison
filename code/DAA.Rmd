---
title: "Differential abundance analysis - females vs. males"
author: "Noora Sissala"
date: "2025-04-07"
output: html_document
---

## Read in data

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

```

```{r}

library(tidyverse)
library(RColorBrewer)
library(patchwork)
library(ggvenn)
library(eulerr)
library(ggpubr)
library(ggside)
library(rstatix)
library(scales)

source('code/utility_functions.R')
source('code/plotting_functions.R')
source('code/DAA_functions.R')

# Result directory
path <- 'results/DAA'

if (!dir.exists(path)) {
  dir.create(path, recursive = TRUE)
}

#### Read in data ####

# Olink Explore data
olink_data <- read_OlinkExplore_data(withControlSamples = FALSE,
                                     withReplicateAssays = FALSE,
                                     withBelowLOD = TRUE, # keep <LOD values
                                     withQCWarning = TRUE, # keep proteins/samples with QC warning
                                     removeAllLOD = TRUE) # remove proteins with all values <LOD 

# Calculate percentage of LOD values per protein
below_LOD <- olink_data %>% 
  group_by(UniProt) |> 
  summarize(Perc.below.LOD = sum(NPX < LOD)/n()*100)

olink_data_wide <- olink_long_to_wide(olink_data, id_cols = 'UniProt')


# Olink data with LOD values set to NA
olink_data_clean <- read_OlinkExplore_data(withControlSamples = FALSE,
                                           withReplicateAssays = FALSE,
                                           withBelowLOD = FALSE, # set <LOD values to NA
                                           withQCWarning = TRUE, # keep proteins/samples with QC warning
                                           removeAllLOD = TRUE) # remove proteins with all values <LOD

olink_data_clean_wide <- olink_long_to_wide(olink_data_clean, id_cols = 'UniProt')

# Olink proteins with no values <LOD 
olink_noBelowLOD <- na.omit(olink_data_clean_wide)


# MS data
ms_data <- read_MS_data(withIS = FALSE, # remove internal standards
                        withReplicateSamples = FALSE) |> # remove replicate samples
dplyr::select(all_of(colnames(olink_data_wide))) # select only overlapping samples

# Remove proteins with any missing values
ms_noNA <- na.omit(ms_data)

# Overlapping proteins
overlap <- intersect(olink_data_wide$UniProt, ms_data$UniProt)
length(overlap)

# Proteins with no missing values in MS and values <LOD in Olink data
overlap_no_missing <- intersect(olink_noBelowLOD$UniProt, ms_noNA$UniProt)
length(overlap_no_missing)

# Proteins with no truly missing values (NAs) - MS no missing vs. all Olink proteins
overlap_no_NA <- intersect(olink_data_wide$UniProt, ms_noNA$UniProt)
length(overlap_no_NA)

# Metadata
metadata <- read.delim('data/metadata/participant_metadata.txt') |> 
  filter(Sample.ID %in% unique(olink_data$Sample.ID))

# Protein annotations
protein_metadata <- read.csv('data/metadata/protein_metadata.csv') %>% 
  filter(OlinkID %in% unique(olink_data$OlinkID) | UniProt %in% ms_data$UniProt)

# Color palette
daa_pal <- setNames(c(TDP_palette[c(1,4, 13)], 'grey50'),
                    c('MS only', 'Olink only', 'Both', 'None'))


```


## Differential abundance analysis (DAA)

Differential abundance analysis was performed between males and females as an example. Analysis was performed on overlapping proteins with no missing values in MS or Olink data (N = 569). 


```{r}

# Define groups
male <- metadata[metadata$Sex == 'Male', 'Sample.ID']
female <- metadata[metadata$Sex == 'Female', 'Sample.ID']

```

Function for the analysis:

```{r}

DAA <- function(ms_data, olink_data, test_grp, ref_grp, path, filename,
                         protein_metadata, p_adjust = TRUE) {
  
  library(tidyverse)
  library(ggplot2)
  library(patchwork)
  library(ggpp)
  
  
  # Perform DAA for MS data
  ms_res <- ms_data %>% 
    rowwise.t.test(test_grp = test_grp, ref_grp = ref_grp) %>% 
    mutate(variable = ms_data$UniProt) %>% 
    dplyr::rename(UniProt = variable)
  
  if (!p_adjust) {
    ms_res <- ms_res |> 
      mutate(adj.p = p.value)
  }
  
  # Perform DAA for Olink data
  olink_res <- olink_data %>% 
    rowwise.t.test(test_grp = test_grp, ref_grp = ref_grp) %>% 
    mutate(variable = olink_data$UniProt) %>% 
    dplyr::rename(UniProt = variable) |> 
    rowwise()
  
  if (!p_adjust) {
    olink_res <- olink_res |> 
      mutate(adj.p = p.value)
  }
  
  # Combine results
  daa_res <- bind_rows('MS' = ms_res, 'Olink' = olink_res, .id = 'Platform') |> 
    left_join(protein_metadata, by = 'UniProt') |> 
    dplyr::select(Platform, UniProt, Gene.Name, Description, Assay, OlinkID, Panel,
                  everything()) |> 
    mutate(Significance = ifelse(adj.p < 0.05, 'S', 'NS'))
  
  # Save result table
  write.csv(daa_res, paste0(path, '/DAA_sex_res_', filename, '.csv'))
  
  # Wide format
    daa_res_wide <- daa_res %>% 
    pivot_wider(id_cols = UniProt,
                names_from = Platform,
                names_sep = '_',
                values_from = c(statistic, log2FC, p.value, adj.p, n.total)) %>% 
    filter(!is.na(log2FC_MS) & !is.na(log2FC_Olink)) |>
    # Create column indicating which platform the protein is significant in
    mutate(Significance = case_when(adj.p_MS < 0.05 & adj.p_Olink < 0.05 ~ 'Both',
                           adj.p_MS < 0.05 & adj.p_Olink >= 0.05 ~ 'MS only',
                           adj.p_MS >= 0.05 & adj.p_Olink < 0.05 ~ 'Olink only',
                           TRUE ~ 'None'),
           Alpha = ifelse(Significance == 'None', 'None', 'Other'),
           Significance = factor(Significance, levels = c('Both', 'MS only', 'Olink only', 'None'))) 
  
  # Add labels to be used in volcano plots (if MS gene name is lacking, use Olink assay name)
    ms_res <- ms_res |> 
    left_join(protein_metadata, by = 'UniProt') |> 
    mutate(Gene.Name = ifelse(is.na(Gene.Name), Assay, Gene.Name))
  
  olink_res <- olink_res |>
    left_join(protein_metadata, by = 'UniProt') |>
    mutate(Gene.Name = ifelse(is.na(Gene.Name), Assay, Gene.Name))

  
  ## Volcano plots
  
  # Select proteins to label
  ms_labels <- full_join(
    slice_max(filter(ms_res, adj.p < 0.05), abs(log2FC), n = 10),
    slice_min(filter(ms_res, adj.p < 0.05), p.value, n = 10),
    by = colnames(ms_res))
  
  # Plot volcano
  ms_volcano <- DAA_volcano(ms_res, ms_labels) + labs(title = 'MS')
  
  # Select proteins to label
  olink_labels <- full_join(
    slice_max(filter(olink_res, adj.p < 0.05), abs(log2FC), n = 10),
    slice_min(filter(olink_res, adj.p < 0.05), p.value, n = 10),
    by = colnames(olink_res))
  
  # Plot volcano
  olink_volcano <- DAA_volcano(olink_res, olink_labels) + labs(title = 'Olink')
  
  # Combine plots
  volcano_plot <- ms_volcano + olink_volcano + 
    plot_layout(guides = 'collect', axes = 'collect') &
    theme(legend.position = 'top')
  
  ggsave(plot = volcano_plot,
         filename = paste0('DAA_sex_volcano_', filename, '.pdf'),
         path = path,
         width = 12,
         height = 7,
         units = 'cm')
  
  print(volcano_plot)
  
  # Venn diagram of DAPs
  ms_sig <- filter(ms_res, adj.p < 0.05) %>% pull(UniProt)
  olink_sig <- filter(olink_res, adj.p < 0.05) %>% pull(UniProt)
  
  venn_data <- data.frame(UniProt = union(ms_sig, olink_sig)) |> 
    mutate(MS = UniProt %in% ms_sig,
           Olink = UniProt %in% olink_sig)
  
  # Plot and save Venn diagram
  pdf(file = paste0(path, '/DAA_sex_venn_', filename, '.pdf'),
      width = 5*0.393701, height = 5*0.393701)
  
    venn_diag <- plot(euler(
      combinations = venn_data[c('MS', 'Olink')]),
      fills = list(fill = TDP_palette[c(1,4)], alpha = 0.5), 
      edges = list(lwd = 2.5, col = TDP_palette[c(1,4)]),
      quantities = list(fontsize = 7, font = 'regular', fontfamily = 'Helvetica'), 
      labels = list(fontsize = 8, font = 'regular', fontfamily = 'Helvetica'),
      main = list(label = 'Differentially abundant proteins\n(Females vs. males)',
                  cex = 8 / par('ps')))
                  
  
    # Adjust plot to smaller size
    venn_diag$vp$width <- unit(0.8, "npc")
    venn_diag$vp$height <- unit(0.8, "npc")
    
    print(venn_diag)
    
  dev.off()
    
  print(venn_diag)
  
  ## Agreement of log2FC values
  
  # Percent agreement of log2FC values for all tested proteins
  perc_agreement <- daa_res |> 
    pivot_wider(id_cols = UniProt,
                names_from = Platform,
                values_from = log2FC) |> 
    filter(!is.na(MS) & !is.na(Olink)) |>
    mutate(Agreement = sign(MS) == sign(Olink)) |> 
    summarize(Perc.agreement = mean(Agreement, na.rm = T) * 100)
  
  # Scatter plot of log2FC agreement (all proteins)
  min_log2fc <- min(daa_res$log2FC, na.rm = TRUE)
  max_log2fc <- max(daa_res$log2FC, na.rm = TRUE)
  
  cor_res <- cor.test(daa_res_wide$log2FC_MS, daa_res_wide$log2FC_Olink,
  method = 'pearson')
  
  cor_label <- paste0('R = ', round(cor_res$estimate, 2))
  
  log2fc_plot1 <- ggplot(
    daa_res_wide, aes(x = log2FC_MS, y = log2FC_Olink, color = Significance, alpha = Alpha)) +
    geom_point(size = 0.75) +
    geom_quadrant_lines(lwd = 0.3) +
    geom_abline(lwd = 0.3) +
    annotate(
      'text_npc', npcx = 0.55, npcy = 0.15,
      label = paste0(
        "Directional\nagreement: ", round(perc_agreement$Perc.agreement), '%'),
      hjust = 0, size = 6/.pt
    ) +
    annotate(
      'text_npc', npcx = 0.55, npcy = 0.05,
      label = cor_label, hjust = 0, size = 6/.pt
    ) +
    scale_alpha_manual(values = c(0.4, 0.9), guide = 'none') +
    scale_color_manual(values = daa_pal) +
    labs(x = 'log2-fold change (MS)', 
         y = 'log2-fold change (Olink)',
         color = 'Significant in',
         title = 'All tested proteins') +
    theme_publ() +
    theme(legend.position = 'right',
          legend.direction = 'vertical') +
    coord_fixed(xlim = c(min_log2fc, max_log2fc), 
                 ylim = c(min_log2fc, max_log2fc))
  
  # Percent agreement of log2FC values for significant proteins only
  sig_any <- daa_res_wide |> 
    filter(Significance != 'None') |> 
    pull(UniProt)
  
  perc_agreement2 <- daa_res |> 
    filter(UniProt %in% sig_any) |>
    pivot_wider(id_cols = UniProt,
                names_from = Platform,
                values_from = log2FC) |> 
    filter(!is.na(MS) & !is.na(Olink)) |>
    mutate(Agreement = sign(MS) == sign(Olink)) |> 
    summarize(Perc.agreement = mean(Agreement, na.rm = T) * 100)
  
  cor_res2 <- cor.test(
    daa_res_wide$log2FC_MS[daa_res_wide$UniProt %in% sig_any],
    daa_res_wide$log2FC_Olink[daa_res_wide$UniProt %in% sig_any],
    method = 'pearson')
  
  cor_label2 <- paste0('R = ', round(cor_res2$estimate, 2))
  
  # Scatter plot of log2FC agreement (significant proteins)
  log2fc_plot2 <- daa_res_wide |> 
    filter(UniProt %in% sig_any) |>
    ggplot.scatterplot(log2FC_MS, log2FC_Olink, Color_var = Significance, size = 0.75, alpha = 0.9) +
    scale_color_manual(values = daa_pal) +
    geom_quadrant_lines(lwd = 0.3) +
    geom_abline(lwd = 0.3) +
    annotate(
      'text_npc', npcx = 0.55, npcy = 0.15,
      label = paste0(
        "Directional\nagreement: ", round(perc_agreement2$Perc.agreement), '%'),
      hjust = 0, size = 6/.pt
    ) +
    annotate(
      'text_npc', npcx = 0.55, npcy = 0.05,
      label = cor_label2, hjust = 0, size = 6/.pt
    ) +
    labs(x = 'log2-fold change (MS)', 
         y = 'log2-fold change (Olink)',
         color = 'Significant in',
         title = 'Differentially abundant proteins') +
    theme_publ() +
    theme(legend.position = 'none') +
    coord_fixed(xlim = c(min_log2fc, max_log2fc), 
                 ylim = c(min_log2fc, max_log2fc))
    
  # Combine plots
  log2fc_plot <- (log2fc_plot1 + log2fc_plot2) + 
    plot_layout(axis_titles = 'collect', guides = 'collect') +
    plot_annotation(title = 'Agreement of log2-fold change values',
                    theme = theme(plot.title = element_text(hjust = 0.5, size = 8))) &
    guides(color = guide_legend(override.aes = list(size = 1.5))) 
  
  ggsave(log2fc_plot,
         filename = paste0('DAA_sex_log2FC_agreement_', filename, '.pdf'),
         path = path,
         width = 12,
         height = 6,
         units = 'cm')
  
  print(log2fc_plot)
  
  return(list('DAA_res' = daa_res,
              'DAA_res_wide' = daa_res_wide,
              'volcano_plot' = volcano_plot,
              'venn_diagram' = venn_diag,
              'log2fc_plot' = log2fc_plot))
}


```


### All overlapping proteins

```{r}

daa_res_all_overlap <- DAA(
  filter(ms_data, UniProt %in% overlap), 
  filter(olink_data_wide, UniProt %in% overlap),
  test_grp = female,
  ref_grp = male,
  path = path,
  filename = 'all_overlappingProteins',
  protein_metadata = protein_metadata)

```


Missing values in DAPs

```{r}

ms_NAs <- ms_data |> 
  pivot_longer(cols = -UniProt, 
               names_to = 'Sample.ID', 
               values_to = 'Value') |>
  group_by(UniProt) |> 
  summarize(Missing.MS = sum(is.na(Value)),
            Perc.Missing.MS = Missing.MS/n()*100)
            
missing_values <- ms_NAs |> 
  full_join(below_LOD) |> 
  filter(UniProt %in% overlap) |> 
  pivot_longer(cols = c(Perc.below.LOD, Perc.Missing.MS),
               names_to = 'Platform',
               values_to = 'Missing.values') |>
  mutate(Platform = ifelse(Platform == 'Perc.below.LOD', 'Olink', 'MS'),
         Any.missing = Missing.values > 0) |>
  left_join(daa_res_all_overlap$DAA_res_wide, 
            by = 'UniProt') |> 
  group_by(Platform, Significance) |>
  summarize(Any.missing = sum(Any.missing),
            Total = n(),
            Perc.Any.missing = Any.missing/Total*100)
            

ggplot(missing_values, aes(x = Platform, y = Perc.Any.missing, fill = Significance)) +
  geom_col(position = position_dodge(width = 0.91)) +
  geom_text(
      aes(label = paste0(round(Perc.Any.missing), '%')),
      position = position_dodge(width = 0.9),
      vjust = -0.5, size = 6/.pt, hjust = 0.5
    ) +
  theme_publ() +
  scale_color_manual(values = daa_pal, aesthetics = c('fill', 'color')) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
  labs(x = 'Platform', y = 'Proteins with missing values (%)',
       fill = 'Significant in', title = 'Missing values by significance in DAA') +
  theme(legend.position = 'right')

```
```{r}

ggsave(filename = 'DAPs_missing_values.pdf',
       path = path,
       width = 8.7,
       height = 6,
       units = 'cm')

```



### Overlapping proteins - no missing values / values <LOD

```{r}

daa_res_no_missing_overlap <- DAA(
  filter(ms_noNA, UniProt %in% overlap_no_missing),
  filter(olink_noBelowLOD, UniProt %in% overlap_no_missing),
  test_grp = female,
  ref_grp = male,
  path = path,
  filename = 'noMissing_overlappingProteins',
  protein_metadata = protein_metadata)

```

## Technical CVs by significance in DAA

```{r}

technical_CVs <- read.csv('results/CV_analysis/technical_CVs.csv')

daa_res_all_overlap_wide <- daa_res_all_overlap$DAA_res_wide |> 
  left_join(technical_CVs |> 
              filter(UniProt %in% overlap) |> 
              pivot_wider(id_cols = c(UniProt, Gene.Name),
                          names_from = Platform,
                          values_from = Technical.CV) |> 
              dplyr::rename(Technical.CV_MS = MS, Technical.CV_Olink = Olink),
            by = 'UniProt')

set.seed(1)

plot_data <- daa_res_all_overlap_wide |> 
  filter(Significance != 'None', !is.na(Technical.CV_MS), !is.na(Technical.CV_Olink))

p1 <- ggplot.jitterbox(plot_data, Significance, Technical.CV_MS, show.legend = F) +
  stat_compare_means(comparisons = list(c('MS only', 'Olink only'), c('Both', 'Olink only')),
                     label.y = c(30, 33), size = 6/.pt, tip.length = 0.01,
                     label = 'p.signif') +
  ylim(c(0,35)) +
  labs(x = 'Significant in', y = 'Technical CV (MS)') 
  

p2 <- ggplot.jitterbox(plot_data, Significance, Technical.CV_Olink, show.legend = F) +
  ylim(c(0,35)) +
  stat_compare_means(comparisons = list(c('MS only', 'Olink only'), c('Both', 'MS only')),
                     label.y = c(30, 33), size = 6/.pt, tip.length = 0.01,
                     label = 'p.signif') +
  labs(x = 'Significant in', y = 'Technical CV (Olink)') 

p1 + p2 +
  plot_annotation(title = 'Technical CVs by significance in DAA',
                  theme = theme(plot.title = element_text(size = 8, hjust = 0.2))) &
  scale_color_manual(values = daa_pal, aesthetics = c('fill', 'color')) 

```

```{r}

ggsave(filename = 'technical_CV_by_significance.pdf',
       path = path,
       width = 8.7,
       height = 6,
       units = 'cm')

```


## Fold change comparison

```{r}

daa_res_all_overlap$DAA_res_wide %>% 
  filter(Significance != 'None') %>% 
  pivot_longer(cols = c(log2FC_MS, log2FC_Olink),
               names_to =  c('.value', 'Platform'),
               names_sep = '_') %>% 
  ggplot.density(log2FC, Fill_var = Platform, median_text = F, median_line = F) +
  scale_fill_manual(values = TDP_palette[c(1,4)], aesthetics = c('color', 'fill')) +
  theme_publ() +
  labs(x = 'log2-fold change', title = 'Log2-fold change of DAPs by platform')


ggsave(filename = 'DAPs_log2FC_density.pdf',
       path = path,
       width = 8.7,
       height = 6,
       units = 'cm')


```


## Estimated concentration of DAPs

```{r}

hpa_data <- read.delim('data/processed_data/HPA_v24_clean.txt')

conc_data <- hpa_data %>% 
  filter(!is.na(Blood.conc.ngmL)) %>% 
  distinct(Uniprot, Blood.conc.IM.pgL, Blood.conc.MS.pgL, .keep_all = TRUE) |> 
  dplyr::select(Uniprot, Blood.conc.MS.pgL, Blood.conc.IM.pgL, Blood.conc.ngmL)

dens_data <- daa_res_all_overlap$DAA_res  |> 
  filter(Significance == 'S') |>
  inner_join(conc_data, by = c('UniProt' = 'Uniprot'))

plot_data <- daa_res_all_overlap$DAA_res_wide  |> 
  filter(Significance != 'None') |> 
  inner_join(conc_data, by = c('UniProt' = 'Uniprot')) |> 
  mutate(Significance = droplevels(Significance))

stat_test <- wilcox_test(
  Blood.conc.ngmL ~ Significance, 
  data = plot_data) |> 
  add_xy_position(y.trans = log10)

set.seed(1)

plot_data |> 
  ggplot(aes(x = Significance, y = Blood.conc.ngmL)) +
  geom_jitter(aes(color = Significance), alpha = 0.8, width = 0.3, size = 0.5) +
  geom_boxplot(aes(fill = Significance), alpha = 0.5, outliers = F) +
  scale_y_log10(labels = log10_format(), breaks = 10^seq(-1,9,2)) +
  small_logticks('l') +
  labs(x = 'Significant in', 
       y = 'Concentration in blood (ng/mL)',
       title = 'Estimated concentration of DAPs') +
  scale_fill_manual(values = daa_pal,
                    aesthetics = c('color', 'fill')) +
  theme_publ() +
  theme(ggside.axis.line = element_blank(),
        ggside.axis.ticks = element_blank(),
        ggside.axis.text = element_blank(),
        ggside.panel.scale.y = 0.2) +
  geom_ysidedensity(data = dens_data,
                    mapping = aes(y = Blood.conc.ngmL, yfill = Platform, ycolor = Platform), 
                    alpha = 0.5) +
  scale_ycolor_manual(values = TDP_palette[c(1,4)], aesthetics = c('ycolor', 'yfill')) +
  guides(fill = 'none', color = 'none') +
  stat_pvalue_manual(stat_test, tip.length = 0.02, label.size = 6/.pt, step.increase = 0.1,
                     bracket.nudge.y = 0.5)


ggsave(filename = 'DAPs_by_conc_boxplot.pdf',
       path = path,
       width = 8.7,
       height = 6,
       units = 'cm')


```


## Replication of DAPs in other data sets


### All overlapping proteins

```{r}

calculate_replication <- function(my_data, external_data) {
  # my_data should have columns UniProt, Platform, Significance, and Difference
  # external_data should have columns UniProt, Significance, and Difference
  # difference is assumed to be with positive value = higher in males
  # proteins with duplicate assays in external_data are considered as replicated
  # if any of the assays are replicated
  
  my_data |> 
    filter(Significance == 'S') |> 
    left_join(external_data, by = 'UniProt', suffix = c('_Sissala', '_External')) |>
    group_by(UniProt) |>  # handle duplicated proteins in external data
    summarize(
      Platform = unique(Platform),
      Testable = any(!is.na(Significance_External)),
      DAP.in.both = any(Significance_Sissala == 'S' & Significance_External == 'S'),
      Same.direction = any(sign(Difference_Sissala) == sign(Difference_External)),
      Fully.replicated = any(DAP.in.both & Same.direction)
    ) |> 
    filter(Testable) |>
    group_by(Platform) |>
    summarize(
      Testable.DAPs = sum(Testable),
      DAP.in.both = sum(DAP.in.both),
      Replication.rate = DAP.in.both / sum(Testable.DAPs) * 100,
      Same.direction = sum(Same.direction),
      Replicated.direction.rate = Same.direction / sum(Testable.DAPs) * 100,
      Fully.replicated = sum(Fully.replicated),
      Fully.replicated.rate = Fully.replicated / sum(Testable.DAPs) * 100,
      .groups = 'drop'
    )
}


# Prepare data for replication analysis
my_data_all_overlapping <- daa_res_all_overlap$DAA_res |> 
  mutate(log2FC = log2FC * -1) |>  # ensure male is positive
  dplyr::select(UniProt, Platform, Significance, Difference = log2FC)


koprulu <- readxl::read_excel('data/external_data/41467_2025_59034_MOESM3_ESM.xlsx',
                              sheet = 2, skip = 1) |> 
  mutate(across(where(is.character), ~na_if(., 'NA')),
         across(c(starts_with('beta'), starts_with('pval'), starts_with('se')),
                   as.numeric))

koprulu_soma <- koprulu |> 
  filter(!is.na(beta.SL)) |> 
  dplyr::select(UniProt, beta.SL, se.SL, pval.SL) |> 
  distinct() |> 
  mutate(Adj.p = p.adjust(pval.SL, method = 'fdr'),
         Significance = ifelse(Adj.p < 0.05, 'S', 'NS')) |> 
  dplyr::select(UniProt, Difference = beta.SL, Significance)
         
          
koprulu_olink <- koprulu |> 
  filter(!is.na(beta.OL)) |> 
  dplyr::select(UniProt, beta.OL, se.OL, pval.OL) |> 
  distinct() |> 
  mutate(Adj.p = p.adjust(pval.OL, method = 'fdr'),
         Significance = ifelse(Adj.p < 0.05, 'S', 'NS')) |>
  dplyr::select(UniProt, Difference = beta.OL, Significance)



zhong_daps <- readxl::read_excel('data/external_data/41467_2021_22767_MOESM6_ESM.xlsx',
                            skip = 3) 

zhong_all <- readxl::read_excel('data/external_data/41467_2021_22767_MOESM4_ESM.xlsx',
                                skip = 2)

zhong <- zhong_all |> 
  left_join(zhong_daps, by = 'Protein') |> 
  dplyr::select(UniProt, Difference = `Log2FC (male/female)`, Significance = `P-value`) |> 
  mutate(Significance = ifelse(is.na(Significance) | Significance  >= 0.05, 'NS', 'S'))


dordevic <- readxl::read_excel('data/external_data/43856_2025_856_MOESM4_ESM.xlsx') |> 
  dplyr::select(UniProt = Uniprot, Difference = coef_SexWomen, pval = p.value_SexWomen) |> 
  separate_longer_delim(cols = UniProt, delim = ';') |> 
  mutate(Difference = Difference * -1, # ensure male is positive
         Adj.p = p.adjust(pval, method = 'fdr'),
         Significance = ifelse(Adj.p < 0.05, 'S', 'NS')) |> 
  distinct()
  
```

```{r}

input <- list(
  'Koprulu.Soma' = koprulu_soma,
  'Koprulu.Olink' = koprulu_olink,
  'Zhong.Olink' = zhong,
  'Dordevic.MS' = dordevic
)

repl_all_overlapping <- lapply(input, calculate_replication, my_data = my_data_all_overlapping) |> 
  bind_rows(.id = 'Dataset')

repl_all_overlapping

```

```{r}

plot_replication <- function(results) {
  
  results |> 
    mutate(
      Dataset = case_when(
      Dataset == 'Koprulu.Soma' ~ 'Koprulu et al. (SomaScan)',
      Dataset == 'Koprulu.Olink' ~ 'Koprulu et al. (Olink)',
      Dataset == 'Zhong.Olink' ~ 'Zhong et al. (Olink)',
      Dataset == 'Dordevic.MS' ~ 'Dordevic et al. (MS)'
      )) |>
    ggplot.barplot(Dataset, Fully.replicated.rate, Fill_var = Platform, position = 'dodge') +
    # add N above bars
    geom_text(
      aes(label = paste0(round(Fully.replicated.rate), '%')),
      position = position_dodge(width = 0.9),
      vjust = -0.5, size = 6/.pt, hjust = 0.5
    ) +
    scale_fill_manual(values = TDP_palette[c(1,4)]) +
    theme_publ() +
    labs(title = 'Replication of DAPs in other data sets',
         x = 'Dataset', y = 'Replication rate (%)')  +
    scale_y_continuous(expand = expansion(mult = c(0, 0.1))) 
    
}


p1 <- plot_replication(repl_all_overlapping) +
  labs(subtitle = 'All overlapping proteins (N = 1129)') 

p1


```

### Overlapping proteins - no missing values

```{r}

# Prepare data for replication analysis
my_data_no_missing <- daa_res_no_missing_overlap$DAA_res |> 
  mutate(log2FC = log2FC * -1) |>  # ensure male is positive
  dplyr::select(UniProt, Platform, Significance, Difference = log2FC)


repl_no_missing <- lapply(input, calculate_replication, my_data = my_data_no_missing) |> 
  bind_rows(.id = 'Dataset')

repl_no_missing

```


```{r}

p2 <- plot_replication(repl_no_missing) +
  labs(subtitle = 'No missing values (N = 569)')

p2

```

```{r}

(p1 + theme(plot.margin = margin(l = 10, r = 5.5, b = 5.5, t = 5.5))) + 
  (p2 + labs(title = '')) +
  guide_area() +
  plot_layout(guides = 'collect', widths = c(1,1,0.1)) &
  theme(axis.text.x = element_text(angle = 20, hjust = 1),
        legend.direction = 'vertical')

```
```{r}

ggsave(filename = 'replication_of_DAPs.pdf',
       path = path,
       width = 12,
       height = 7,
       units = 'cm')

```

## Session info

```{r}

writeLines(capture.output(sessionInfo()), file.path(path, 'session_info.txt'))

```


