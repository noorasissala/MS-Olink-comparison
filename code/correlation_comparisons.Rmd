---
title: "Comparison with cross-platform correlations from other studies"
author: "Noora Sissala"
date: "2025-04-09"
output: html_document
---


## Included studies


Comparison with MS-Olink correlations from:

- "Multiplatform Approach for Plasma Proteomics: Complementarity of Olink Proximity Extension Assay Technology to Mass Spectrometry-Based Protein Profiling" (Petrera et al., 2021) (DDA MS, DIA MS, and Olink data)
- "Multi-platform proteomic analysis of Alzheimerâ€™s disease cerebrospinal fluid and plasma reveals network biomarkers associated with proteostasis and the matrisome" (Dammer et al., 2022) (MS, Olink, and SomaScan data)
- "The Current Landscape of Plasma Proteomics: Technical Advances, Biological Insights, and Biomarker Discovery" (Kirsher et al., 2025, preprint). (MS, Olink, and SomaScan data)


Comparison with MS-SomaScan correlations from:

- Dammer et al.
- Kirsher et al.


Comparison with Olink-SomaScan correlations from:

- Dammer et al.
- "Proteomic profiling platforms head to head: Leveraging genetics and clinical traits to compare aptamer- and antibody-based methods" (Katz et al, 2022),
- "Large-scale plasma proteomics comparisons through genetics and disease associations" (Eldjarn et al, 2023), 
-  "Synergistic insights into human health from aptamer- and antibody-based proteomic profiling" (Pietzner et al, 2021),
- "Comparison of Proteomic Measurements Across Platforms in the Atherosclerosis Risk in Communities (ARIC) Study" (Rooney et al., 2023),
- "Comparison of Proteomic Assessment Methods in Multiple Cohort Studies" (Raffield et al., 2020),
- "Dual-platform affinity proteomics identifies links between the recurrence of ovarian carcinoma and proteins released into the tumor microenvironment" (Finkernagel et al., 2019),
- "Stability and reproducibility of proteomic profiles in epidemiological studies: comparing the Olink and SOMAscan platforms" (Haslam et al., 2022).
- Kirsher et al. 
- "Correlations Within and Between Highly Multiplexed Proteomic Assays of Human Plasma" (Rooney et al., 2025)


+ Analysis of our MS-Olink correlations by confidence tiers from Eldjarn et al., which were based on Olink-SomaScan correlations and the presence of pQTLs.


## Load data


```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

```


```{r, message = FALSE}

library(tidyverse)
library(readxl)
library(ggrepel)
library(ggside)
library(ggpp)
library(ggpubr)
library(patchwork)

source('code/utility_functions.R')
source('code/plotting_functions.R')
source('code/correlation_analysis_functions.R')

path <- path <- "results/correlation_comparisons"

if (!dir.exists(path)) {
  dir.create(path, recursive = TRUE)
}

```

```{r, message=FALSE}

# Load correlations from this study
my_cors <- read.csv('results/correlation_analysis/MS-Olink_protein_cor_table.csv') |> 
  dplyr::rename(Correlation_Sissala = Correlation_Spearman,
                P.value_Sissala = P.value_Spearman,
                Adj.p.value_Sissala = Adj.p.value_Spearman,
                N_Sissala = N,
                Cor.interval_Sissala = Cor.interval_Spearman) |> 
  dplyr::select(UniProt, Gene.Name, OlinkID, Description, contains('Sissala')) |> 
  dplyr::relocate(N_Sissala, .after = Correlation_Sissala) |> 
  mutate(Cor.method_Sissala = 'Spearman')

# Petrera et al.
petrera_olink_ann <- read_xlsx('data/external_data/pr0c00641_si_003.xlsx', 
                               range = 'A5:ABY8', col_names = F,
                               .name_repair = 'universal_quiet') |> 
  t() |> 
  as.data.frame()
colnames(petrera_olink_ann) <- petrera_olink_ann[1,]
petrera_olink_ann <- petrera_olink_ann[-1,]
rownames(petrera_olink_ann) <- NULL

petrera_LOD <-read_xlsx('data/external_data/pr0c00641_si_003.xlsx', 
                        range = 'A184:ABY186', col_names = F,
                        .name_repair = 'universal_quiet') |> 
  t() |> 
  as.data.frame()
colnames(petrera_LOD) <- make.names(petrera_LOD[1,])
petrera_LOD <- petrera_LOD[-1,]
rownames(petrera_LOD) <- NULL
petrera_LOD <- petrera_LOD |> 
  mutate(across(1:2, as.numeric))

petrera_NPX <- read_xlsx('data/external_data/pr0c00641_si_003.xlsx', 
                           range = 'A10:ABY182', col_names = F,
                         .name_repair = 'universal_quiet') |> 
  t() |> 
  as.data.frame()
colnames(petrera_NPX) <- petrera_NPX[1,]
petrera_NPX <- petrera_NPX[-1,]
rownames(petrera_NPX) <- NULL

petrera_olink <- bind_cols(petrera_olink_ann, petrera_LOD, petrera_NPX) |>  
  # Exclude OlinkIDs that were excluded in the original paper
  filter(!OlinkID %in% c('OID00947', 'OID00666', 'OID01009', 'OID00684')) |> 
  mutate(across(starts_with('PM'), as.numeric))
  

petrera_dda_samples <- read_xlsx('data/external_data/pr0c00641_si_004.xlsx',
                                 sheet = 2, range = 'H1:FY2', col_names = F,
                                 .name_repair = 'universal_quiet') |> 
  t() |> 
  as.data.frame()
colnames(petrera_dda_samples) <- petrera_dda_samples[1,]
petrera_dda_samples <- petrera_dda_samples[-1,]
rownames(petrera_dda_samples) <- NULL

petrera_dda <- read_xlsx('data/external_data/pr0c00641_si_004.xlsx',
                         sheet = 1, skip = 4, .name_repair = 'universal_quiet') |> 
  dplyr::select(1:6, contains('Normalized')) |> 
  dplyr::rename_with(\(x) str_extract(x, '(?<=\\.Normalized\\.\\.\\.).*(?=\\.\\.Sample)'),
                     contains('Sample', ignore.case = F)) |> 
  mutate(across(starts_with('F'), log2))  # log2-transform values

colnames(petrera_dda) <- ifelse(
  colnames(petrera_dda) %in% petrera_dda_samples$`ID (PD2.3)`,
  petrera_dda_samples$`Sample ID`[match(colnames(petrera_dda), petrera_dda_samples$`ID (PD2.3)`)],
  colnames(petrera_dda))

petrera_dda_norm <- petrera_dda |> 
  # median-center the DDA-MS data
  mutate(across(starts_with('PM'),  function(x) x - median(x, na.rm = T))) 

# Calculate MS-Olink correlations for Petrera et al.
# match proteins between technologies by UniProt ID
# calculate Spearman correlations

source('code/correlation_analysis_functions.R')

petrera_dda_olink_cors <- cor.test.df(
  dplyr::select(petrera_dda, Accession, starts_with('PM')),
  dplyr::select(petrera_olink, `Uniprot ID`, OlinkID, starts_with('PM')),
  match_by = c('Accession', 'Uniprot ID'),
  cor_type = 'rowwise', cor_method = 'spearman',
  cols_to_keep = c('OlinkID')) |> 
  dplyr::rename(UniProt = Accession, 
                Correlation_Previous.study = Correlation,
                P.value_Previous.study = P.value,
                Adj.p.value_Previous.study = Adj.p.value,
                N_Previous.study = N) 

# Dammer et al.

dammer_soma_olink_cors <- read_xlsx(
  'data/external_data/13195_2022_1113_MOESM2_ESM.xlsx',
  sheet = '13.Olink.SomaScan.Corr.Plasma', skip = 3,
  .name_repair = 'universal_quiet') |> 
  dplyr::rename(Olink = OlinkAssay,
                SomaScan = SomaAssay) |>
  separate_wider_delim(cols = c(Olink, SomaScan),
                       names = c('Gene.Name', 'UniProt'),
                       names_sep = '.',
                       delim = '|') |> 
  separate_wider_delim(cols = SomaScan.UniProt,
                       names = c('SomaScan.UniProt', 'SomaID'),
                       delim = '^',
                       too_few = 'align_start') |> 
  filter(SomaScan.UniProt == Olink.UniProt) |> 
  separate_wider_delim(SomaID, delim = '@', names = c('SomaID', 'SomaScan.SeqID')) |>
  dplyr::rename(UniProt = Olink.UniProt,
                Correlation_Previous.study = all.cor,
                P.value_Previous.study = all.p,
                N_Previous.study = all.nObs)
  
dammer_ms_olink_cors <- read_xlsx(
  'data/external_data/13195_2022_1113_MOESM2_ESM.xlsx',
  sheet = '15.Olink.MS.Corr.Plasma', skip = 3,
  .name_repair = 'universal_quiet') |> 
  dplyr::select(-1) |> 
  dplyr::rename(Olink = OlinkAssay,
                MS = Msprotein) |>
  separate_wider_delim(cols = c(Olink, MS),
                       names = c('Gene.Name', 'UniProt'),
                       names_sep = '.',
                       delim = '|') |> 
  filter(MS.UniProt == Olink.UniProt) |> 
  dplyr::rename(UniProt = Olink.UniProt,
                Correlation_Previous.study = all.cor,
                P.value_Previous.study = all.p,
                N_Previous.study = all.nObs)

dammer_ms_soma_cors <- read_xlsx(
  'data/external_data/13195_2022_1113_MOESM2_ESM.xlsx',
  sheet = '17.MS.SomaScan.Corr.Plasma', skip = 3,
  .name_repair = 'universal_quiet') |> 
  dplyr::select(-1) |> 
  dplyr::rename(MS = MSprotein,
                SomaScan = SomaAssay) |>
  separate_wider_delim(cols = c(MS, SomaScan),
                       names = c('Gene.Name', 'UniProt'),
                       names_sep = '.',
                       delim = '|') |>
  separate_wider_delim(cols = SomaScan.UniProt,
                       names = c('SomaScan.UniProt', 'SomaID'),
                       delim = '^',
                       too_few = 'align_start') |> 
  filter(SomaScan.UniProt == MS.UniProt) |> 
  separate_wider_delim(SomaID, delim = '@', names = c('SomaID', 'SomaScan.SeqID')) |>
  dplyr::rename(UniProt = MS.UniProt,
                Correlation_Previous.study = all.cor,
                P.value_Previous.study = all.p,
                N_Previous.study = all.nObs)

# Nilsson et al.
nilsson_cors <- read_xlsx(
  'data/external_data/004_corr_shared.xlsx',
  .name_repair = 'universal_quiet') |> 
  mutate(UniProt = str_remove(UnitedIDs, '.+_'),
         .after = 1) |> 
  dplyr::rename(Correlation_Previous.study = Corr,
                P.value_Previous.study = p,
                Adj.p.value_Previous.study = p_adjust) |> 
  mutate(N_Previous.study = 16) # proteins with missing values were removed, so N is 16 for all proteins

# Katz et al
katz_cors <- read_xlsx('data/external_data/sciadv.abm5164_tables_s1_to_s6.xlsx',
                       sheet = 'Table S2', skip = 1,
                       .name_repair = 'universal_quiet') %>% 
  filter(!is.na(Soma.Target) & !is.na(Olink.Target)) |> 
  dplyr::rename(UniProt = UniProt.x,
                Correlation_Previous.study = rho,
                P.value_Previous.study = p...11,
                SomaScan.SeqID = SomamerId,
                SomaID = SomaId) |> 
  mutate(N_Previous.study = 568) # assuming that values <LOD were retained, there were no missing values, so N is 568 for all proteins
                
# Eldjarn et al
eldjarn_cors <- read_xlsx('data/external_data/41586_2023_6563_MOESM3_ESM.xlsx',
                          sheet = 'ST6_assay_correlations', skip = 3, 
                          .name_repair = 'universal_quiet', col_types = 'text') |> 
  mutate(across(7:17, as.numeric)) |> 
  dplyr::rename(UniProt = uniprot,
                Correlation_Previous.study = olink_smpnorm_corr,
                P.value_Previous.study = olink_smpnorm_pval,
                SomaScan.SeqID = seqid,
                OlinkID = oid) |> 
  mutate(N_Previous.study = 1514)  # assuming that values <LOD were retained, there were no missing values, so N is 1514 for all proteins

eldjarn_tiers <- read_xlsx('data/external_data/41586_2023_6563_MOESM3_ESM.xlsx',
                          sheet = 'ST29_protein_classification', skip = 2, 
                          .name_repair = 'universal_quiet', col_types = 'text') |> 
  filter(Targeted.Olink == 'Y', Targeted.Soma == 'Y') |> 
  mutate(olink.smp.corr = as.numeric(olink.smp.corr)) |>
  dplyr::rename(Correlation_Eldjarn = olink.smp.corr,
                P.value_Eldjarn = olink.smp.pval,
                SomaScan.SeqID = SeqId,
                cis.pQTL.olink_Eldjarn = cis.pQTL.olink,
                cis.pQTL.soma_Eldjarn = cis.pQTL.soma,
                confidence.tier_Eldjarn = confidence.tier) |>
  dplyr::select(UniProt, OlinkID, SomaScan.SeqID,
                Correlation_Eldjarn, P.value_Eldjarn,
                cis.pQTL.olink_Eldjarn, cis.pQTL.soma_Eldjarn,
                confidence.tier_Eldjarn)
                
 

# Pietzner et al
pietzner_cors <- read_xlsx('data/external_data/41467_2021_27164_MOESM5_ESM.xlsx',
                           skip = 2, .name_repair = 'universal_quiet') |> 
  filter(!is.na(SomaScan.SeqID) & !is.na(OlinkID)) |> 
  dplyr::rename(UniProt = UniprotID,
                Correlation_Previous.study = Spearman.correlation.coefficient..normalised.) |> 
  mutate(N_Previous.study = 485) # values <LOD were retained, so there were no missing values and N is 485 for all proteins
                

# Rooney et al
rooney2023_cors <- read_xlsx(
  'data/external_data/02 Proteomics validation Supp 20220815 SF1 updated.xlsx',
  sheet = 'ST3 soma v olink', range = 'A2:AN419',
  .name_repair = 'universal_quiet') |> 
  mutate(across(15:16, as.numeric)) |> 
  filter(!is.na(SOMAmer.SeqID) & !is.na(OlinkID),
         UniprotID != 'NA') |> 
  dplyr::rename(UniProt = UniprotID,
                Correlation_Previous.study = Correlation.SomaScan.vs.Olink,
                P.value_Previous.study = P.value.Correlation.SomaScan.vs.Olink,
                SomaScan.SeqID = SOMAmer.SeqID) |> 
  mutate(N_Previous.study = 427) # values <LOD were imputed, so there were no missing values and N is 427 for all proteins


# Rooney et al (2025)
rooney2025_cors <- read_xlsx(
  'data/external_data/03 Supplemental Tables 20241010 R3.xlsx',
  sheet = 'ST6', skip = 2, na = 'NA',
  .name_repair = 'universal_quiet') |> 
  filter(UniprotID.Soma.11k == UniprotID.Olink) |> 
  dplyr::rename(UniProt = UniprotID.Soma.11k,
                Correlation_Previous.study = Soma.vs.Olink.Spearman.s.r,
                SomaScan.SeqID = SeqID) |> 
  mutate(N_Pevious.study = 102) # values <LOD were retained, so there were no missing values and N is 102 for all proteins)

# Raffield et al.
raffield_cors <- read_xlsx(
  'data/external_data/pmic13292-sup-TableS9.xlsx') |> 
  dplyr::rename(Correlation_Previous.study = rs,
                N_Previous.study = n,
                SomaID = SomaId)

# Finkeragel et al.
finkernagel_cors <- read_xlsx(
  'data/external_data/thnov09p6601s1.xlsx',
  sheet = 'Table S5', .name_repair = 'universal_quiet') |> 
  dplyr::rename(Gene.Name = ...1,
                Correlation_Previous.study = Spearman.rho) |> 
  mutate(N_Previous.study = 50) # assuming that values <LOD were retained, there were no missing values, so N is 50 for all proteins

# Haslam et al.
haslam_cors <- read_xlsx(
  'data/external_data/pmic13529-sup-0001-tabless1-s17.xlsx',
  sheet = 'Supplemental Table S12', .name_repair = 'universal_quiet',
  skip = 2) |> 
  dplyr::rename(UniProt = UniprotID,
                Correlation_Previous.study = r,
                SomaID = SomaId,
                SomaScan.SeqID = Sequence.ID,
                OlinkID = FIELDNAMES) |> 
  mutate(N_Previous.study = NA_real_) # <LOD values were removed, so there are missing values, but N is not given

# Kirsher et al.
kirsher_cors <- read_xlsx(
  'data/external_data/media-1.xlsx',
  sheet = 'S4 - Interplatform Correlation', 
  .name_repair = 'universal_quiet',
  skip = 1) |> 
  mutate(Spearman.Rho = as.numeric(Spearman.Rho),
         N_Previous.study = 78) |> # vaues <LOD were retained, so there are no missing values and N is 78 for all proteins
  dplyr::rename(Correlation_Previous.study = Spearman.Rho)

```

```{r}

cor_tables <- list(
  'Petrera et al.' = petrera_dda_olink_cors,
  'Dammer et al. (MS-Olink)' = dammer_ms_olink_cors,
  'Dammer et al. (MS-SomaScan)' = dammer_ms_soma_cors,
  'Dammer et al. (Olink-SomaScan)' = dammer_soma_olink_cors,
  'Nilsson et al.' = nilsson_cors,
  'Katz et al.' = katz_cors,
  'Eldjarn et al.' = eldjarn_cors,
  'Pietzner et al.' = pietzner_cors,
  'Rooney et al. (2023)' = rooney2023_cors,
  'Rooney et al. (2025)' = rooney2025_cors,
  'Raffield et al.' = raffield_cors,
  'Finkernagel et al.' = finkernagel_cors,
  'Haslam et al.' = haslam_cors,
  'Kirsher et al. (MS HAP Depletion - Olink 3K)' = kirsher_cors |> 
    filter(Platform_1 == 'MS - HAP Depletion', Platform_2 == 'Olink 3K'),
  'Kirsher et al. (MS HAP Depletion - Olink 5K)' = kirsher_cors |>
    filter(Platform_1 == 'MS - HAP Depletion', Platform_2 == 'Olink 5K'),
  'Kirsher et al. (MS HAP Depletion - SomaScan 7K)' = kirsher_cors |>
    filter(Platform_1 == 'MS - HAP Depletion', Platform_2 == 'SomaScan 7K'),
  'Kirsher et al. (MS HAP Depletion - SomaScan 11K)' = kirsher_cors |>
    filter(Platform_1 == 'MS - HAP Depletion', Platform_2 == 'SomaScan 11K'),
  'Kirsher et al. (Olink 3K - SomaScan 7K)' = kirsher_cors |>
    filter(Platform_1 == 'Olink 3K', Platform_2 == 'SomaScan 7K'),
  'Kirsher et al. (Olink 3K - SomaScan 11K)' = kirsher_cors |>
    filter(Platform_1 == 'Olink 3K', Platform_2 == 'SomaScan 11K'),
  'Kirsher et al. (Olink 5K - SomaScan 7K)' = kirsher_cors |>
    filter(Platform_1 == 'Olink 5K', Platform_2 == 'SomaScan 7K'),
  'Kirsher et al. (Olink 5K - SomaScan 11K)' = kirsher_cors |>
    filter(Platform_1 == 'Olink 5K', Platform_2 == 'SomaScan 11K')) |> 
  map(\(x) dplyr::select(
    x, any_of(c('UniProt', 'Gene.Name', 'Correlation_Previous.study', 'N_Previous.study',
                'P.value_Previous.study', 'Adj.p.value_Previous.study', 'SomaID', 
                'SomaScan.SeqID', 'OlinkID', 'Platform_1', 'Platform_2',
                'Platform_1_Analyte', 'Platform_2_Analyte'))))

comparisons <- tibble(
  Study = names(cor_tables),
  Comparison = case_when(
    Study %in% c('Petrera et al.', 'Dammer et al. (MS-Olink)', 'Nilsson et al.', 
                 'Kirsher et al. (MS HAP Depletion - Olink 3K)', 
                 'Kirsher et al. (MS HAP Depletion - Olink 5K)') ~ 'MS-Olink',
    Study %in% c('Dammer et al. (MS-SomaScan)', 
                 'Kirsher et al. (MS HAP Depletion - SomaScan 7K)',
                 'Kirsher et al. (MS HAP Depletion - SomaScan 11K)') ~ 'MS-SomaScan',
    Study %in% c('Dammer et al. (Olink-SomaScan)', 'Katz et al.', 'Eldjarn et al.',
                 'Pietzner et al.', 'Rooney et al. (2023)', 'Rooney et al. (2025)',
                 'Raffield et al.', 'Finkernagel et al.', 'Haslam et al.',
                 'Kirsher et al. (Olink 3K - SomaScan 7K)', 
                 'Kirsher et al. (Olink 3K - SomaScan 11K)',
                 'Kirsher et al. (Olink 5K - SomaScan 7K)',
                 'Kirsher et al. (Olink 5K - SomaScan 11K)') ~ 'Olink-SomaScan'
  )
)

cor_table <- cor_tables |>
  bind_rows(.id = 'Study') |>
  # Get SomaScan.SeqID and OlinkID for Kirsher correlations
  mutate(
    OlinkID = case_when(
      str_detect(Platform_1, 'Olink') ~ Platform_1_Analyte,
      str_detect(Platform_2, 'Olink') ~ Platform_2_Analyte,
      TRUE ~ OlinkID
    ),
    
    SomaScan.SeqID = case_when(
      str_detect(Platform_1, 'SomaScan') ~ Platform_1_Analyte,
      str_detect(Platform_2, 'SomaScan') ~ Platform_2_Analyte,
      TRUE ~ SomaScan.SeqID
    )
  ) |>
  left_join(comparisons, by = 'Study') |>
  mutate(Cor.interval_Previous.study = cor_intervals(Correlation_Previous.study),
         Cor.method_Previous.study = ifelse(
           str_detect(Study, 'Dammer'), 'Pearson', 'Spearman')) |>
  filter(!is.na(Correlation_Previous.study)) |> 
  left_join(my_cors, by = 'UniProt', suffix = c('_Previous.study', '_Sissala')) |> 
  left_join(my_cors, by = join_by(Gene.Name_Previous.study == Gene.Name), suffix = c('', '_x')) |> 
  mutate(Correlation_Sissala = coalesce(Correlation_Sissala, Correlation_Sissala_x),
         P.value_Sissala = coalesce(P.value_Sissala, P.value_Sissala_x),
         Adj.p.value_Sissala = coalesce(Adj.p.value_Sissala, Adj.p.value_Sissala_x),
         N_Sissala = coalesce(N_Sissala, N_Sissala_x),
         Cor.interval_Sissala = coalesce(Cor.interval_Sissala, Cor.interval_Sissala_x),
         Description = coalesce(Description, Description_x),
         UniProt = coalesce(UniProt, UniProt_x),
         Gene.Name = coalesce(Gene.Name_Previous.study, Gene.Name_Sissala)) |>
  dplyr::select(Study, Comparison, UniProt, Gene.Name, Description, SomaID,
                SomaScan.SeqID, contains('OlinkID'), everything(),
                -contains('_x', ignore.case = FALSE), -Gene.Name_Previous.study, 
                -Gene.Name_Sissala, -contains('Platform'), -OlinkID)
  

```

Summary of number of comparisons, overlapping proteins between technologies, and overlapping proteins with the present study:

```{r}

study_summary <- cor_table |> 
  group_by(Study, Comparison) |>
  summarise(
    Total.N = n(),
    Unique.proteins = if ('Finkernagel et al.' %in% cur_group()$Study) {
      n_distinct(Gene.Name)
    } else {
      n_distinct(UniProt)
    },
    Overlap.with.present.study = length(intersect(my_cors$UniProt, UniProt)),
    .groups = 'drop') |> 
  arrange(Comparison, desc(Unique.proteins))


study_summary

```


For proteins with several cross-platform correlations due to multiple Olink/SomaScan assays targeting the same protein, we calculated the cross-platform correlation as the median of individual correlations between the different assays. 

```{r}

cor_table_summarized <- cor_table |> 
  filter(Study != 'Finkernagel et al.') |> # skip study matched by gene name, has one correlation per gene
  group_by(Study, Comparison, UniProt) |> 
  summarize(Correlation_Previous.study = median(Correlation_Previous.study, na.rm = TRUE),
            Correlation_Sissala = unique(Correlation_Sissala)) |> 
  bind_rows(filter(cor_table, Study == 'Finkernagel et al.')) # put back Finkernagel et al. correlations

```

```{r}

# Add median correlation to summary table
study_medians <- cor_table_summarized |> 
  group_by(Study, Comparison) |> 
  summarise(Median.correlation = median(Correlation_Previous.study, na.rm = TRUE),
            Correlation.Q1 = quantile(Correlation_Previous.study, 0.25, na.rm = TRUE),
            Correlation.Q3 = quantile(Correlation_Previous.study, 0.75, na.rm = TRUE),
            Unique.proteins = n())

overlap_medians <- cor_table_summarized |> 
  group_by(Study, Comparison) |> 
  filter(!is.na(Correlation_Previous.study), !is.na(Correlation_Sissala)) |>
  summarise(Median.correlation_Overlap = median(Correlation_Previous.study, na.rm = TRUE),
            Correlation.Q1_Overlap = quantile(Correlation_Previous.study, 0.25, na.rm = TRUE),
            Correlation.Q3_Overlap = quantile(Correlation_Previous.study, 0.75, na.rm = TRUE),
            Overlap.with.present.study = n())
  

study_summary <- study_summary |> 
  left_join(study_medians, by = c('Study', 'Comparison', 'Unique.proteins')) |> 
  left_join(overlap_medians, by = c('Study', 'Comparison', 'Overlap.with.present.study'))

study_summary

write.csv(study_summary, file.path(path, 'study_summary.csv'),
          row.names = FALSE)
  

```




## Comparison with other MS-Olink studies


### Overall correlation distribution

```{r}

median_df <- study_summary |> 
  filter(Comparison == 'MS-Olink') |> 
  mutate(Label = paste('Median:', round(Median.correlation, 2), '\nN =', Unique.proteins))

cor_table_summarized |> 
  filter(Comparison == 'MS-Olink') |> 
  ggplot(aes(x = Correlation_Previous.study)) +
  geom_histogram(binwidth = 0.05, fill = 'steelblue', color = 'steelblue', alpha = 0.95) +
  facet_wrap(~ Study, ncol = 2, scales = 'free_y') +
  # add median line
  geom_vline(aes(xintercept = median(Correlation_Previous.study, na.rm = TRUE)),
             linetype = 'dashed', size = 0.3) +
  # add median text
  geom_text_npc(data = median_df, 
                aes(npcx = 'left', npcy = 'top', label = Label),
                size = 6/.pt) +
  labs(x = 'MS-Olink correlation', y = 'Count', title = 'MS-Olink correlations across studies')

```

### Correlation of overlapping protein pairs

Function for plotting histograms of correlations between overlapping proteins in the present study and previous studies:

```{r}

comparison_histogram <- function(cor_table, comparison, ncol = 2, nrow = NULL,
                                   facet_labels = NULL) {
  
  # Prepare data
  cor_table <- cor_table %>%
    filter(Comparison == comparison, 
           !is.na(Correlation_Previous.study), 
           !is.na(Correlation_Sissala))
  
  facet_data <- cor_table %>%
    dplyr::rename(
      `Present study` = Correlation_Sissala,
      `Previous study` = Correlation_Previous.study
    ) %>%
    pivot_longer(cols = c(`Present study`, `Previous study`),
                 names_to = "Study.group", values_to = "Correlation")
  
  # Compute medians for annotation
  median_df <- facet_data %>%
    group_by(Study, Study.group) %>%
    summarise(Median = median(Correlation, na.rm = TRUE), .groups = "drop",
              Study_label = ifelse(unique(Study.group) == 'Present study', 
                     'Sissala et al.',
                     str_remove(unique(Study), "(?<=\\.).*"))) |> 
    mutate(
      label = paste0('Median ', Study_label, ': ', round(Median, 2)),
      npcx = "left",
      npcy = ifelse(Study.group == "Present study", 0.9, 0.85)
    )
  
  # Sample size annotation
  n_df <- cor_table %>% 
    group_by(Study) %>% 
    summarise(
      N = n(),
      N.unique = ifelse(Study[1] == 'Finkernagel et al.', 
                        n_distinct(Gene.Name), 
                        n_distinct(UniProt)),
      Label = ifelse(N != N.unique,
                     paste0('N = ', N, ' (', N.unique, ' unique)'),
                     paste0('N = ', N)),
      npcx = "left",
      npcy = 0.95
    )
  
  # Wilcoxon p-values
  pval_df <- facet_data %>%
    group_by(Study) %>%
    summarise(
      p.value = wilcox.test(Correlation ~ Study.group, data = facet_data[cur_group_rows(), ])$p.value,
      npcx = "left",
      npcy = 0.8) |> 
    ungroup() |> 
    # adjust p-values with FDR method
    mutate(
      p.adj = p.adjust(p.value, method = "fdr"),
      pval_label = format_pval_label(p.adj))
      
    
  
  # Default empty named vector if NULL
  if (is.null(facet_labels)) {
    facet_labels <- setNames(character(0), character(0))
  }
  
  # Build plot
  p <- ggplot(facet_data) +
    geom_histogram(aes(Correlation, fill = Study.group, color = Study.group), 
                   binwidth = 0.05, position = 'identity',
                   alpha = 0.5, color = 'grey30', lwd = 0.3) +
    geom_text_npc(data = median_df, aes(npcx = npcx, npcy = npcy, label = label, color = Study.group),
                  size = 6 / .pt) +
    geom_text_npc(data = n_df, aes(npcx = npcx, npcy = npcy, label = Label),
                  size = 6 / .pt, fontface = 'bold') +
    geom_text_npc(data = pval_df, aes(npcx = npcx, npcy = npcy, label = pval_label),
                  size = 6 / .pt, parse = TRUE) +
    geom_vline(data = median_df, aes(xintercept = Median, color = Study.group),
               lwd = 0.3, linetype = 'dashed') +
    facet_wrap(~ Study, scales = "free_y", ncol = ncol, nrow = nrow,
               labeller = labeller(Study = facet_labels), axes = 'all') +
    theme_publ() +
    scale_y_continuous(expand = expansion(mult = c(0, 0.05))) +
    labs(fill = 'Study', color = 'Study', x = 'Cross-platform correlation', y = 'Count')
  
  
  
  return(p)
}


```

```{r, fig.width=7, fig.height=8}


comparison_histogram(cor_table_summarized, comparison = 'MS-Olink', ncol = 2, 
                       facet_labels = c('Dammer et al. (MS-Olink)' = 'Dammer et al.'))
  
```

```{r}

ggsave(filename = 'MS-Olink_cors_overlappingProteins.pdf',
       path = path,
       width = 18,
       height = 18,
       units = 'cm')

```

Save correlation table for overlapping proteins between previous MS-Olink studies and the present study:

```{r}

ms_olink_cors <- cor_table |> 
  filter(Comparison == 'MS-Olink', !is.na(Correlation_Previous.study),
         !is.na(Correlation_Sissala)) |>
  select(Study, UniProt, Gene.Name, Description, contains('Previous.study'), 
         contains('Sissala')) |> 
  mutate(Study = ifelse(str_detect(Study, 'Dammer'),
                       'Dammer et al.', Study))

write.csv(ms_olink_cors, file.path(path, 'MS-Olink_cor_comparisons.csv'),
          row.names = FALSE)

```


## Comparison with other MS-SomaScan studies

### Overall correlation distribution

```{r}

median_df <- study_summary |> 
  filter(Comparison == 'MS-SomaScan') |> 
  mutate(Label = paste('Median:', round(Median.correlation, 2), '\nN =', Unique.proteins))


cor_table_summarized |>
  filter(Comparison == 'MS-SomaScan') |> 
  ggplot(aes(x = Correlation_Previous.study)) +
  geom_histogram(binwidth = 0.05, fill = 'steelblue', color = 'steelblue', alpha = 0.95) +
  facet_wrap(~ Study, ncol = 2, scales = 'free_y') +
  # add median line
  geom_vline(aes(xintercept = median(Correlation_Previous.study, na.rm = TRUE)),
             linetype = 'dashed', size = 0.3) +
  # add median text
  geom_text_npc(data = median_df, 
                aes(npcx = 'left', npcy = 'top', label = Label),
                size = 6/.pt) +
  labs(x = 'MS-SomaScan correlation', y = 'Count', title = 'MS-SomaScan correlations across studies')

```

### Correlation of overlapping protein pairs


```{r}

comparison_histogram(cor_table_summarized, comparison = 'MS-SomaScan', ncol = 2,
                       facet_labels = c('Dammer et al. (MS-SomaScan)' = 'Dammer et al.'))

```

```{r}

ggsave(filename = 'MS-SomaScan_cors_overlappingProteins.pdf',
       path = path,
       width = 18,
       height = 12,
       units = 'cm')

```

Save correlation table for overlapping proteins between previous MS-SomaScan studies and the present study:

```{r}

ms_soma_cors <- cor_table |> 
  filter(Comparison == 'MS-SomaScan', !is.na(Correlation_Previous.study),
         !is.na(Correlation_Sissala)) |>
  select(Study, UniProt, Gene.Name, Description, SomaID, SomaScan.SeqID,
         contains('Previous.study'), contains('Sissala')) |> 
  mutate(Study = ifelse(str_detect(Study, 'Dammer'),
                       'Dammer et al.', Study))

write.csv(ms_soma_cors, file.path(path, 'MS-SomaScan_cor_comparisons.csv'),
          row.names = FALSE)

```



## Comparison with other Olink-SomaScan studies

### Overall correlation distribution

```{r, fig.width=7, fig.height=8}

median_df <- study_summary |> 
  filter(Comparison == 'Olink-SomaScan') |> 
  mutate(Label = paste('Median:', round(Median.correlation, 2), '\nN =', Unique.proteins))


cor_table_summarized |>
  filter(Comparison == 'Olink-SomaScan') |> 
  ggplot(aes(x = Correlation_Previous.study)) +
  geom_histogram(binwidth = 0.05, fill = 'steelblue', color = 'steelblue', alpha = 0.95) +
  facet_wrap(~ Study, ncol = 3, scales = 'free_y') +
  # add median line
  geom_vline(aes(xintercept = median(Correlation_Previous.study, na.rm = TRUE)),
             linetype = 'dashed', size = 0.3) +
  # add median text
  geom_text_npc(data = median_df, 
                aes(npcx = 'left', npcy = 'top', label = Label),
                size = 6/.pt) +
  labs(x = 'Olink-SomaScan correlation', y = 'Count', title = 'Olink-SomaScan correlations across studies')

```

### Correlation of overlapping protein pairs

```{r, fig.width=7, fig.height=10}

facet_labels <- c('Dammer et al. (Olink-SomaScan)' = 'Dammer et al.')

olink_soma_studies <- cor_table_summarized |> 
  filter(Comparison == 'Olink-SomaScan') |> 
  pull(Study) |> 
  unique()

cor_table_summarized |> 
  filter(Study %in% olink_soma_studies[1:8]) |> 
  comparison_histogram(comparison = 'Olink-SomaScan', nrow = 4, ncol = 2,
                       facet_labels = facet_labels) +
  labs(caption = 'Continued on the next page') +
  theme(plot.caption = element_text(hjust = 0.5, size = 8, face = 'bold',
                                    margin = margin(t = 10, b = 10)))
  

ggsave(filename = 'Olink-SomaScan_cors_overlappingProteins_page1.pdf',
       path = path,
       width = 18,
       height = 25,
       units = 'cm')

```

```{r, fig.width=7, fig.height=8}

cor_table_summarized |> 
  filter(Study %in% olink_soma_studies[9:length(olink_soma_studies)]) |>
  comparison_histogram(comparison = 'Olink-SomaScan', nrow = 3, ncol = 2,
                       facet_labels = facet_labels)

ggsave(filename = 'Olink-SomaScan_cors_overlappingProteins_page2.pdf',
       path = path,
       width = 18,
       height = 18,
       units = 'cm')


```




Save correlation table for overlapping proteins between previous Olink-SomaScan studies and the present study:

```{r}

olink_soma_cors <- cor_table |> 
  filter(Comparison == 'Olink-SomaScan', !is.na(Correlation_Previous.study),
         !is.na(Correlation_Sissala)) |>
  select(Study, UniProt, Gene.Name, Description, SomaID, SomaScan.SeqID,
         contains('Previous.study'), contains('Sissala')) |> 
  mutate(Study = ifelse(str_detect(Study, 'Dammer'),
                       'Dammer et al.', Study))

write.csv(olink_soma_cors, file.path(path, 'Olink-SomaScan_cor_comparisons.csv'),
          row.names = FALSE)

```


## Cross-platform correlations by Eldjarn confidence tiers

```{r}

# Merge correlations from the current study and Eldjarn et al.
tier_cors <- my_cors |> 
  inner_join(eldjarn_tiers, by = c('UniProt', 'OlinkID')) |>
  dplyr::select(1:4, SomaScan.SeqID, Correlation_Sissala, P.value_Sissala, 
                Adj.p.value_Sissala, N_Sissala, 
                Correlation_Eldjarn, P.value_Eldjarn, 
                contains('cis.pQTL'), confidence.tier_Eldjarn) |> 
  # Which platform each cis-pQTL was identified on
  mutate(cis.pQTL.platform_Eldjarn = case_when(
    cis.pQTL.olink_Eldjarn == 'Y' & cis.pQTL.soma_Eldjarn == 'Y' ~ 'Both',
    cis.pQTL.olink_Eldjarn == 'Y' & cis.pQTL.soma_Eldjarn == 'N' ~ 'Olink only',
    cis.pQTL.soma_Eldjarn == 'Y' & cis.pQTL.olink_Eldjarn == 'N' ~ 'SomaScan only',
    cis.pQTL.soma_Eldjarn == 'N' & cis.pQTL.olink_Eldjarn == 'N' ~ 'None'),
    cis.pQTL.platform_Eldjarn = factor(
      cis.pQTL.platform_Eldjarn, 
      levels = c('Both', 'Olink only', 'SomaScan only', 'None')),
    # Add column for high correlation in both studies
    High.corr.in.both.studies = Correlation_Sissala > 0.7 & Correlation_Eldjarn > 0.7)
                
# Color palette for confidence tiers
tier_palette <- desaturate(darken(brewer.pal(3, 'Set2')[c(1,3,2)]), -0.2)


```


```{r}

# Calculate median cross-platform correlation by confidence tier
median_df <- tier_cors |> 
  group_by(confidence.tier_Eldjarn) |> 
  summarise(Median.Eldjarn = median(Correlation_Eldjarn, na.rm = TRUE),
            Median.Sissala = median(Correlation_Sissala, na.rm = T))

tier_cors |>
  ggplot.scatterplot(Correlation_Eldjarn, Correlation_Sissala, 
                     Color_var = confidence.tier_Eldjarn,
                   xlab = 'Olink-SomaScan correlation (Eldjarn et al.)',
                   ylab = 'MS-Olink correlation (Sissala et al.)', 
                   title = 'MS-Olink vs. Olink-SomaScan correlations',
                   alpha = 0.8) +
  # Add density plots showing the distribution of cross-platform correlations to the sides
  geom_xsidedensity(aes(fill = confidence.tier_Eldjarn), alpha = 0.5) +
  geom_ysidedensity(aes(fill = confidence.tier_Eldjarn), alpha = 0.5) +
  geom_xsidevline(data = median_df,
                  mapping = aes(xintercept = Median.Eldjarn, color = confidence.tier_Eldjarn),
                  linetype = 'dashed', show.legend = F) +
  geom_ysidehline(data = median_df, 
                  mapping = aes(yintercept = Median.Sissala, color = confidence.tier_Eldjarn),
                  linetype = 'dashed', show.legend = F) +
  theme_publ()  +
  theme(ggside.axis.text = element_blank(),
        ggside.axis.line = element_blank(),
        ggside.axis.ticks = element_blank()) +
  labs(fill = 'Confidence tier (Eldjarn et al.)', color = 'Confidence tier (Eldjarn et al.)',
       x = 'Olink-SomaScan correlation (Eldjarn et al.)',
       y = 'MS-Olink correlation (Sissala et al.)') +
  geom_abline(linetype = 'dashed', lwd = 0.4)  +
  scale_color_manual(values = tier_palette,
                     aesthetics = c('color', 'fill')) +
  scale_x_continuous(expand = expansion(mult = c(0.02, 0)),
                     limits = c(-0.5, 1)) +
  scale_y_continuous(expand = expansion(mult = c(0.02, 0)),
                     limits = c(-0.5, 1))

median_df

```

```{r}

ggsave(filename = 'Eldjarn_confidence_tier_cors.pdf',
       path = path,
       width = 8.7,
       height = 7.5,
       units = 'cm')

```

```{r}

write.csv(tier_cors, file.path(path, 'Eldjarn_confidence_tier_cors.csv'), row.names = F)

```


Boxplot of cross-platform correlation by tiers:

```{r}

set.seed(1)
p1 <- ggplot.jitterbox(tier_cors, confidence.tier_Eldjarn, Correlation_Sissala, show.legend = F) +
  geom_pwc(method = 't.test', tip.length = 0.02, label.size = 6/.pt,
           p.adjust.method = 'fdr', label = 'p.adj.signif', step.increase = 0.1) +
  labs(x = 'Confidence tier (Eldjarn et al.)', y = 'MS-Olink correlation (Sissala et al.)') +
  scale_color_manual(values = tier_palette,
                     aesthetics = c('color', 'fill')) +
  labs(title = 'MS-Olink correlation')

p2 <- ggplot.jitterbox(tier_cors, confidence.tier_Eldjarn, Correlation_Eldjarn, show.legend = F) +
  geom_pwc(method = 't.test', tip.length = 0.02, label.size = 6/.pt,
           p.adjust.method = 'fdr', label = 'p.adj.signif', step.increase = 0.1) +
  labs(x = 'Confidence tier (Eldjarn et al.)', y = 'Olink-SomaScan correlation (Eldjarn et al.)') +
  scale_color_manual(values = tier_palette,
                     aesthetics = c('color', 'fill')) +
  labs(title = 'Olink-SomaScan correlation')

p1 | p2

```

```{r}

ggsave(filename = 'cor_by_tier_boxplot.pdf',
       path = path,
       width = 11.3,
       height = 7,
       units = 'cm')

```


Cross-platform correlation by pQTLs:

```{r}

set.seed(1)
tier_cors |> 
  ggplot.jitterbox(cis.pQTL.platform_Eldjarn, Correlation_Sissala, show.legend = F) +
  labs(x = 'cis pQTL in (Eldjarn et al.)', y = 'MS-Olink correlation (Sissala et al.)') +
  theme(ggside.axis.text = element_blank(),
        ggside.axis.line = element_blank(),
        ggside.axis.ticks = element_blank(),
        ggside.panel.scale = 0.2) +
  geom_pwc(method = 't.test', p.adjust.method = 'fdr', 
           tip.length = 0.02, label.size = 6/.pt, label = 'p.adj.signif', step.increase = 0.1) +
  stat_group_counts(label.x = 'cis.pQTL.platform')
  
  

```

```{r}

ggsave(filename = 'MS-Olink_cor_by_Eldjarn_pQTLs.pdf',
       path = path,
       width = 8.7,
       height = 6.5,
       units = 'cm')


```


```{r}

set.seed(1)
tier_cors |> pivot_longer(
  cols = c(Correlation_Sissala, Correlation_Eldjarn), 
  names_to = c('.value', 'Study'),
  names_sep = '_') |>
  mutate(Study = ifelse(
    Study == 'Sissala', 'Sissala et al.', 'Eldjarn et al.'),
    Study = factor(Study, levels = c('Sissala et al.', 'Eldjarn et al.'))) |> 
  ggplot.jitterbox(confidence.tier_Eldjarn, Correlation, Color_var = Study) +
  geom_pwc(method = 'wilcox_test', label.size = 6/.pt, tip.length = 0.02,
           label = 'p.adj.signif', p.adjust.method = 'fdr') +
  theme_publ() +
  labs(x = 'Confidence tier (Eldjarn et al.)', y = 'Cross-platform correlation', fill = 'Study')

```

```{r}

ggsave(filename = 'cor_by_tier_Sissala_vs_Eldjarn.pdf',
       path = path,
       width = 8.7,
       height = 6.5,
       units = 'cm')

```


